<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Anketa ÄÃ­tanie svÃ¤tÃ©ho pÃ­sma</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f3f4f6;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }
  </style>
</head>
<body>
  <div id="app" class="max-w-4xl w-full bg-white p-6 rounded-xl shadow-xl text-center">
    <h1 class="text-3xl font-extrabold text-gray-800 mb-4">ğŸ“– Anketa ÄÃ­tanie svÃ¤tÃ©ho pÃ­sma</h1>
    <p id="question-display" class="text-xl text-blue-700 font-bold mb-6">NaÄÃ­ta sa otÃ¡zka...</p>
    <div id="people-list" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6"></div>
    <div id="summary" class="border-t pt-4">
      <h2 class="text-lg font-semibold text-gray-700 mb-2">SÃºhrn hlasovania</h2>
      <div id="total-summary" class="grid grid-cols-2 sm:grid-cols-4 gap-3"></div>
    </div>
    <p id="message" class="text-sm text-gray-600 mt-4"></p>
    <div id="error-message" class="text-red-600 font-medium mt-4 hidden">Chyba pripojenia.</div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, increment, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // ğŸ”¥ Tvoja Firebase konfigurÃ¡cia
    const firebaseConfig = {
      apiKey: "AIzaSyAfs4NluHtDInHgmD22DHYDLt6ypl008DU",
      authDomain: "citanie-sv.firebaseapp.com",
      projectId: "citanie-sv",
      storageBucket: "citanie-sv.firebasestorage.app",
      messagingSenderId: "16378682541",
      appId: "1:16378682541:web:be64c5a5fff65055657a24",
      measurementId: "G-VM2CKF7QYS"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const PEOPLE = {
      adka: "AÄka",
      danka: "Danka",
      emilia: "EmÃ­lia",
      ivan: "Ivan",
      janka: "Janka",
      marketka: "MarkÃ©tka",
      milan: "Milan"
    };

    const questionDisplay = document.getElementById("question-display");
    const peopleList = document.getElementById("people-list");
    const totalSummary = document.getElementById("total-summary");
    const errorMessage = document.getElementById("error-message");
    const message = document.getElementById("message");

    const POLL_DOC_PATH = "polls/svate_pismo";
    const INITIAL_QUESTION = "Kto pravidelne ÄÃ­ta SvÃ¤tÃ© PÃ­smo?";

    async function init() {
      try {
        const docRef = doc(db, POLL_DOC_PATH);
        const docSnap = await getDoc(docRef);
        if (!docSnap.exists()) {
          const peopleInit = {};
          Object.keys(PEOPLE).forEach(k => (peopleInit[k] = { yes: 0, no: 0 }));
          await setDoc(docRef, { question: INITIAL_QUESTION, people: peopleInit });
        }
        onSnapshot(docRef, snap => {
          if (snap.exists()) renderPoll(snap.data());
        });
      } catch (err) {
        console.error(err);
        errorMessage.classList.remove("hidden");
      }
    }

    function renderPoll(data) {
      questionDisplay.textContent = data.question;
      peopleList.innerHTML = "";
      totalSummary.innerHTML = "";

      Object.entries(PEOPLE).forEach(([key, name]) => {
        const p = data.people[key] || { yes: 0, no: 0 };
        const total = p.yes + p.no || 1;
        const yesPercent = Math.round((p.yes / total) * 100);
        const noPercent = Math.round((p.no / total) * 100);

        const el = document.createElement("div");
        el.className = "p-4 border rounded-xl shadow bg-gray-50";
        el.innerHTML = `
          <h3 class="text-lg font-bold mb-2">${name}</h3>
          <button class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded mr-2" onclick="vote('${key}','yes')">âœ… Ãno</button>
          <button class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded" onclick="vote('${key}','no')">âŒ Nie</button>
          <div class="mt-3 text-sm text-gray-700">Ãno: ${p.yes} (${yesPercent}%) &nbsp;|&nbsp; Nie: ${p.no} (${noPercent}%)</div>
        `;
        peopleList.appendChild(el);

        // SÃºhrn
        const summaryDiv = document.createElement("div");
        summaryDiv.className =
          p.yes > p.no
            ? "bg-green-100 text-green-800 p-3 rounded-xl font-bold"
            : p.no > p.yes
            ? "bg-red-100 text-red-800 p-3 rounded-xl font-bold"
            : "bg-gray-100 text-gray-700 p-3 rounded-xl font-bold";
        summaryDiv.textContent = `${name}: ${p.yes > p.no ? "ÃNO âœ…" : p.no > p.yes ? "NIE âŒ" : "REMÃZA âšª"}`;
        totalSummary.appendChild(summaryDiv);
      });
    }

    window.vote = async (person, voteType) => {
      const docRef = doc(db, POLL_DOC_PATH);
      await runTransaction(db, async transaction => {
        const pollDoc = await transaction.get(docRef);
        if (!pollDoc.exists()) return;
        const data = pollDoc.data();
        const p = data.people[person];
        if (voteType === "yes") {
          transaction.update(docRef, { [`people.${person}.yes`]: increment(1) });
        } else {
          transaction.update(docRef, { [`people.${person}.no`]: increment(1) });
        }
      });
      message.textContent = "Hlas bol zapoÄÃ­tanÃ½ âœ…";
      setTimeout(() => (message.textContent = ""), 2000);
    };

    init();
  </script>
</body>
</html>
