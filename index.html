<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anketa ƒç√≠tanie sv√§t√©ho p√≠sma</title>
    
    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Fonty -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&family=Noto+Color+Emoji&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', 'Noto Color Emoji', sans-serif;
            background-color: #f3f4f6;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        .spinner { border-top-color: #3b82f6; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }
        #delete-confirmation-modal { transition: opacity 0.3s ease-out; }
        .btn { font-weight: bold; border-radius: 0.75rem; transition: 0.15s; }
    </style>
</head>

<body>
    <div id="app" class="w-full max-w-4xl p-6 md:p-10 bg-white shadow-2xl rounded-xl mx-auto">
        <h1 class="text-4xl font-extrabold text-gray-800 mb-2 text-center flex items-center justify-center">
            <span class="mr-3 text-5xl">üìñ</span> Anketa ƒç√≠tanie sv√§t√©ho p√≠sma
        </h1>
        <div id="main-message-container" class="text-center mt-2 flex justify-center h-6">
            <p id="message-display" class="text-center text-base font-semibold text-gray-500"></p>
        </div>

        <div class="space-y-6">
            <p id="question-display" class="text-2xl md:text-3xl font-extrabold text-blue-700 text-center leading-snug mb-8 p-4 bg-blue-50 rounded-lg shadow-inner">
                Naƒç√≠ta sa ot√°zka...
            </p>
            <div id="people-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 border-t pt-6"></div>
        </div>

        <div id="total-summary-section" class="mt-8 pt-6 border-t border-gray-300">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">S√∫hrn hlasovania (v√§ƒç≈°ina hlasov)</h2>
            <div id="total-summary" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4"></div>
        </div>

        <div class="mt-8 pt-4 border-t text-center">
            <button id="toggle-editor-button" onclick="toggleQuestionEditor()"
                class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-xl shadow-lg">
                Zmeni≈• ot√°zku
            </button>
        </div>

        <div id="question-editor" class="mt-6 p-4 bg-gray-50 rounded-xl border border-gray-200 hidden">
            <h3 class="font-bold text-gray-700 mb-3 text-lg">Editor Ot√°zky</h3>
            <textarea id="new-question-input" rows="2" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 mb-3 text-gray-700 shadow-inner"
                placeholder="Sem zadajte nov√∫ ot√°zku..."></textarea>
            <div class="flex justify-end space-x-2">
                <button onclick="saveQuestion()" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg">Ulo≈æi≈• zmenu</button>
                <button onclick="toggleQuestionEditor(true)" class="bg-gray-400 hover:bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg">Zru≈°i≈•</button>
            </div>
            <p id="editor-message" class="text-sm pt-2 h-5 text-center text-gray-600"></p>
        </div>

        <div class="mt-12 pt-6 border-t border-red-300 text-center">
            <h3 class="text-xl font-bold text-red-600 mb-3">Nebezpeƒçn√° Z√≥na (Re≈°tart)</h3>
            <button id="confirm-delete-button" onclick="confirmDeletePoll()"
                class="bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-xl shadow-lg">
                VYMAZA≈§ ANKETU (Re≈°tart)
            </button>
        </div>

        <div id="loading" class="text-center text-blue-600 font-medium pt-8">
            <div class="inline-block w-6 h-6 border-4 border-gray-200 border-t-4 border-t-blue-600 rounded-full spinner mr-2"></div>
            Naƒç√≠tavam anketu a prip√°jam sa k datab√°ze...
        </div>
        <div id="error-message" class="text-center text-red-600 font-medium hidden pt-8">
            Chyba pri pripojen√≠. Sk√∫ste obnovi≈• str√°nku.
        </div>
    </div>

    <div id="delete-confirmation-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center z-50 p-4">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full">
            <h3 class="text-2xl font-bold text-red-600 mb-3">Naozaj vymaza≈•?</h3>
            <p class="text-gray-700 mb-6">T√Ωmto sa natrvalo vyma≈æ√∫ v≈°etky hlasy a ot√°zka v datab√°ze, a anketa sa nanovo inicializuje s p√¥vodnou ot√°zkou.</p>
            <div class="flex justify-between space-x-4">
                <button onclick="deletePoll()" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-semibold py-2 rounded-lg">√Åno, vymaza≈•</button>
                <button onclick="hideDeleteConfirmation()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 rounded-lg">Zru≈°i≈•</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, runTransaction, increment, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAfs4NluHtDInHgmD22DHYDLt6ypl008DU",
            authDomain: "citanie-sv.firebaseapp.com",
            projectId: "citanie-sv",
            storageBucket: "citanie-sv.appspot.com",
            messagingSenderId: "16378682541",
            appId: "1:16378682541:web:be64c5a5fff65055657a24",
            measurementId: "G-VM2CKF7QYS"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const POLL_DOC_PATH = "polls/svate_pismo";
        const INITIAL_QUESTION = "Kto pravidelne ƒç√≠ta Sv√§t√© P√≠smo?";
        const PEOPLE = { adka:"Aƒèka", danka:"Danka", emilia:"Em√≠lia", ivan:"Ivan", janka:"Janka", marketka:"Mark√©tka", milan:"Milan" };

        const questionDisplay = document.getElementById("question-display");
        const peopleList = document.getElementById("people-list");
        const totalSummary = document.getElementById("total-summary");
        const msg = document.getElementById("message-display");
        const loadingDiv = document.getElementById("loading");
        const errorDiv = document.getElementById("error-message");

        let uid = "anon";
        let ttsReady = false;

        // üîä Pr√≠prava hlasu (TTS)
        function prepareTTS() {
            document.body.addEventListener("click", () => { ttsReady = true; }, { once: true });
        }

        function speak(text) {
            if (!ttsReady) return;
            const utter = new SpeechSynthesisUtterance(text);
            utter.lang = "sk-SK";
            utter.rate = 0.9;
            utter.pitch = 1;
            speechSynthesis.speak(utter);
        }

        async function init() {
            loadingDiv.classList.remove("hidden");
            prepareTTS();
            await signInAnonymously(auth);
            uid = auth.currentUser?.uid || crypto.randomUUID();

            const ref = doc(db, POLL_DOC_PATH);
            const snap = await getDoc(ref);
            if (!snap.exists()) {
                const peopleInit = {};
                Object.keys(PEOPLE).forEach(k => peopleInit[k] = { yes: 0, no: 0 });
                await setDoc(ref, { question: INITIAL_QUESTION, people: peopleInit, userVotes: {} });
            }

            onSnapshot(ref, (ds) => {
                loadingDiv.classList.add("hidden");
                if (ds.exists()) render(ds.data());
            }, (e) => {
                console.error(e);
                errorDiv.classList.remove("hidden");
                loadingDiv.classList.add("hidden");
            });
        }

        function render(data) {
            const q = data.question || INITIAL_QUESTION;
            questionDisplay.textContent = q;
            const people = data.people || {};
            const userVotes = data.userVotes?.[uid] || {};
            peopleList.innerHTML = "";
            totalSummary.innerHTML = "";

            Object.keys(PEOPLE).forEach(key => {
                const name = PEOPLE[key];
                const v = people[key] || { yes: 0, no: 0 };
                const yes = v.yes || 0, no = v.no || 0, total = yes + no;
                const yp = total ? Math.round(yes / total * 100) : 0;
                const np = total ? 100 - yp : 0;
                const my = userVotes[key] || "none";

                const card = document.createElement("div");
                card.className = "p-4 bg-white rounded-xl shadow-lg border border-gray-100";
                card.innerHTML = `
                    <h2 class="text-xl font-bold text-center mb-2">${name}</h2>
                    ${my === "yes" ? `<div class='text-center p-3 bg-green-50 border-2 border-green-500 rounded-lg mb-4'><span class='text-3xl'>üòáüëç</span><p class='text-sm font-semibold text-green-700 mt-1'>Tvoj hlas: √ÅNO</p></div>` :
                    my === "no" ? `<div class='text-center p-3 bg-red-50 border-2 border-red-500 rounded-lg mb-4'><span class='text-3xl'>üòîüëé</span><p class='text-sm font-semibold text-red-700 mt-1'>Tvoj hlas: NIE</p></div>` :
                    `<div class='text-center p-3 bg-gray-50 border rounded mb-4'><p class='text-sm font-semibold text-gray-500'>Zatiaƒæ si nehlasoval/a.</p></div>`}
                    <div class="flex gap-2 mb-3">
                        <button class="flex-1 text-white ${my==='yes'?'bg-green-700':'bg-green-500 hover:bg-green-600'}" onclick="handleVote('${key}','yes')">‚úÖ √Åno</button>
                        <button class="flex-1 text-white ${my==='no'?'bg-red-700':'bg-red-500 hover:bg-red-600'}" onclick="handleVote('${key}','no')">‚ùå Nie</button>
                    </div>
                    <div class="text-sm flex justify-between"><span>√Åno: ${yp}% (${yes})</span><span>Nie: ${np}% (${no})</span></div>
                    <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden"><div class="bg-green-500 h-3" style="width:${yp}%"></div><div class="bg-red-500 h-3" style="width:${np}%"></div></div>
                    <p class="text-xs text-gray-500 text-right">Spolu: ${total} hlasov</p>`;
                peopleList.appendChild(card);
            });
        }

        window.handleVote = async (personKey, newVote) => {
            const ref = doc(db, POLL_DOC_PATH);
            try {
                await runTransaction(db, async (tx) => {
                    const ds = await tx.get(ref);
                    if (!ds.exists()) return;
                    const d = ds.data();
                    const prev = d.userVotes?.[uid]?.[personKey];
                    if (prev === newVote) return;
                    const u = {};
                    if (prev === "yes") u[`people.${personKey}.yes`] = increment(-1);
                    if (prev === "no") u[`people.${personKey}.no`] = increment(-1);
                    u[`people.${personKey}.${newVote}`] = increment(1);
                    u[`userVotes.${uid}.${personKey}`] = newVote;
                    tx.update(ref, u);
                });
                const name = PEOPLE[personKey];
                speak(newVote === "yes"
                    ? `${name}, ƒèakujem ti za tvoj hlas √ÅNO. Boh ti ≈æehnaj.`
                    : `${name}, ƒèakujem ti aj za tvoj hlas NIE. Boh ti ≈æehnaj.`);
            } catch (e) {
                console.error(e);
            }
        };

        init();
    </script>
</body>
</html>
